{% extends "base.html" %}

{% block title %}{{ building.name }} Map - Emergency Evacuation Planner Pro{% endblock %}

{% block content %}
<input type="hidden" id="building-id" value="{{ building.id }}">
<input type="hidden" id="building-width" value="{{ building.width }}">
<input type="hidden" id="building-height" value="{{ building.height }}">

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="fas fa-map me-2"></i>{{ building.name }}
        <small class="text-muted">({{ building.width }}√ó{{ building.height }})</small>
    </h1>
    <a href="/buildings" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Back to Buildings
    </a>
</div>

<div class="controls">
    <h5><i class="fas fa-tools me-2"></i>Map Controls</h5>
    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label"><strong>Hazard Types:</strong></label>
                <div class="hazard-types">
                    <button type="button" class="hazard-btn active" data-type="fire" onclick="selectHazard('fire')">üî• Fire</button>
                    <button type="button" class="hazard-btn" data-type="smoke" onclick="selectHazard('smoke')">üí® Smoke</button>
                    <button type="button" class="hazard-btn" data-type="water" onclick="selectHazard('water')">üíß Water</button>
                    <button type="button" class="hazard-btn" data-type="chemical" onclick="selectHazard('chemical')">‚ò£Ô∏è Chemical</button>
                    <button type="button" class="hazard-btn" data-type="blocked" onclick="selectHazard('blocked')">üöß Blocked</button>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label"><strong>Actions:</strong></label>
                <div class="btn-group w-100">
                    <button type="button" class="btn btn-success" onclick="window.evacuationMap.calculatePath()">
                        <i class="fas fa-route me-2"></i>Find Path
                    </button>
                    <button type="button" class="btn btn-warning" onclick="window.evacuationMap.clearPath()">
                        <i class="fas fa-broom me-2"></i>Clear Path
                    </button>
                    <button type="button" class="btn btn-danger" onclick="window.evacuationMap.clearAll()">
                        <i class="fas fa-trash me-2"></i>Clear All
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Instructions:</strong> 
                Left-click to place start point ‚Üí end point ‚Üí hazards. 
                Right-click to remove. Current hazard: <span id="current-hazard">fire</span>
            </div>
        </div>
    </div>
</div>

<div id="path-result"></div>

<div class="map-container">
    <h5><i class="fas fa-map-marked-alt me-2"></i>Building Layout</h5>
    <div id="grid-map" class="grid-map" style="grid-template-columns: repeat({{ building.width }}, 1fr);"></div>
</div>

<div class="card">
    <div class="card-header">
        <h6 class="mb-0"><i class="fas fa-legend me-2"></i>Map Legend</h6>
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-2 mb-2">
                <div class="grid-cell start mx-auto" style="width: 40px; height: 40px;">üö©</div>
                <small>Start Point</small>
            </div>
            <div class="col-md-2 mb-2">
                <div class="grid-cell end mx-auto" style="width: 40px; height: 40px;">üèÅ</div>
                <small>End Point</small>
            </div>
            <div class="col-md-2 mb-2">
                <div class="grid-cell path mx-auto" style="width: 40px; height: 40px;">‚Ä¢</div>
                <small>Evacuation Path</small>
            </div>
            <div class="col-md-2 mb-2">
                <div class="grid-cell hazard-fire mx-auto" style="width: 40px; height: 40px;">üî•</div>
                <small>Fire Hazard</small>
            </div>
            <div class="col-md-2 mb-2">
                <div class="grid-cell hazard-blocked mx-auto" style="width: 40px; height: 40px;">üöß</div>
                <small>Blocked Area</small>
            </div>
            <div class="col-md-2 mb-2">
                <div class="grid-cell mx-auto" style="width: 40px; height: 40px;"></div>
                <small>Safe Area</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function selectHazard(type) {
    window.evacuationMap.selectedHazardType = type;
    document.getElementById('current-hazard').textContent = type;
    document.querySelectorAll('.hazard-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-type="${type}"]`).classList.add('active');
}

document.addEventListener('DOMContentLoaded', function() {
    const buildingWidth = parseInt(document.getElementById('building-width').value);
    const buildingHeight = parseInt(document.getElementById('building-height').value);
    window.evacuationMap = new EvacuationMap('grid-map', buildingWidth, buildingHeight);
    {% for hazard in hazards %}
    window.evacuationMap.addHazard({{ hazard.x }}, {{ hazard.y }}, '{{ hazard.type }}');
    {% endfor %}
});
</script>
{% endblock %}
